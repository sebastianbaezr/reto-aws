service: reto-aws-serverless-users-java

frameworkVersion: '4'

provider:
  name: aws
  runtime: java17
  region: ${env:AWS_REGION, 'us-east-1'}
  stage: ${env:ENVIRONMENT, 'dev'}
  environment:
    ENVIRONMENT: ${env:ENVIRONMENT, 'dev'}
    DYNAMODB_TABLE_NAME: java-${self:service}-${self:provider.stage}
    USER_CREATED_QUEUE_URL:
      Ref: UserCreatedQueue
    EMAIL_NOTIFICATION_TOPIC_ARN:
      Ref: EmailNotificationTopic
  httpApi:
    metrics: true
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_NAME}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_NAME}/index/email-index

        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:GetQueueUrl
          Resource:
            Fn::GetAtt:
              - UserCreatedQueue
              - Arn

        - Effect: Allow
          Action:
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            Fn::GetAtt:
              - UserCreatedQueue
              - Arn

        - Effect: Allow
          Action:
            - sns:Publish
          Resource:
            Ref: EmailNotificationTopic

package:
  individually: true

functions:
  createUserJava:
    runtime: java17
    handler: co.com.bancolombia.lambda.handler.CreateUserHandler
    description: Create a new user (Java implementation)
    package:
      artifact: build/libs/serverless-java-all.jar
    events:
      - httpApi:
          path: /api/serverless/users
          method: post
    timeout: 30
    memorySize: 256

  getUserJava:
    runtime: java17
    handler: co.com.bancolombia.lambda.handler.GetUserHandler
    description: Get user by ID (Java implementation)
    package:
      artifact: build/libs/serverless-java-all.jar
    events:
      - httpApi:
          path: /api/serverless/users/{id}
          method: get
    timeout: 30
    memorySize: 256

  updateUserJava:
    runtime: java17
    handler: co.com.bancolombia.lambda.handler.UpdateUserHandler
    description: Update user by ID (Java implementation)
    package:
      artifact: build/libs/serverless-java-all.jar
    events:
      - httpApi:
          path: /api/serverless/users/{id}
          method: put
    timeout: 30
    memorySize: 256

  deleteUserJava:
    runtime: java17
    handler: co.com.bancolombia.lambda.handler.DeleteUserHandler
    description: Delete user by ID (Java implementation)
    package:
      artifact: build/libs/serverless-java-all.jar
    events:
      - httpApi:
          path: /api/serverless/users/{id}
          method: delete
    timeout: 30
    memorySize: 256

  enviarCorreosJava:
    runtime: java17
    handler: co.com.bancolombia.lambda.handler.EnviarCorreosHandler
    description: Send welcome email notifications via SNS (Java implementation)
    package:
      artifact: build/libs/serverless-java-all.jar
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - UserCreatedQueue
              - Arn
          batchSize: 10
          functionResponseType: ReportBatchItemFailures
    timeout: 30
    memorySize: 256

resources:
  Resources:
    JavaUsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: java-${self:service}-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: email-index
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    UserCreatedQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: java-${self:service}-user-created-${self:provider.stage}
        VisibilityTimeout: 300
        MessageRetentionPeriod: 1209600
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - UserCreatedDLQ
              - Arn
          maxReceiveCount: 3
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    UserCreatedDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: java-${self:service}-user-created-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    EmailNotificationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: java-${self:service}-email-notifications-${self:provider.stage}
        DisplayName: User Email Notifications
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    UserCreatedQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - Ref: UserCreatedQueue
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                AWS:
                  Fn::GetAtt:
                    - IamRoleLambdaExecution
                    - Arn
              Action:
                - sqs:SendMessage
              Resource:
                Fn::GetAtt:
                  - UserCreatedQueue
                  - Arn

  Outputs:
    UserCreatedQueueUrl:
      Description: URL of the User Created SQS Queue
      Value:
        Ref: UserCreatedQueue
      Export:
        Name: ${self:service}-${self:provider.stage}-UserCreatedQueueUrl

    UserCreatedQueueArn:
      Description: ARN of the User Created SQS Queue
      Value:
        Fn::GetAtt:
          - UserCreatedQueue
          - Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-UserCreatedQueueArn

    EmailNotificationTopicArn:
      Description: ARN of the Email Notification SNS Topic
      Value:
        Ref: EmailNotificationTopic
      Export:
        Name: ${self:service}-${self:provider.stage}-EmailNotificationTopicArn

    HttpApiId:
      Description: ID of the HTTP API Gateway
      Value:
        Ref: HttpApi
      Export:
        Name: ${self:service}-${self:provider.stage}-HttpApiId

