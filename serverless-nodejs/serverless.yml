service: reto-aws-serverless-users-node

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, 'us-east-1'}
  stage: ${env:ENVIRONMENT, 'dev'}
  httpApi:
    id:
      Fn::ImportValue: reto-aws-serverless-users-java-${env:ENVIRONMENT, 'dev'}-HttpApiId
    metrics: true
  environment:
    ENVIRONMENT: ${env:ENVIRONMENT, 'dev'}
    DYNAMODB_TABLE_NAME: node-${self:service}-${self:provider.stage}
    USER_CREATED_QUEUE_URL:
      Ref: UserCreatedQueue
    EMAIL_NOTIFICATION_TOPIC_ARN:
      Ref: EmailNotificationTopic
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_NAME}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_NAME}/index/email-index

        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:GetQueueUrl
          Resource:
            Fn::GetAtt:
              - UserCreatedQueue
              - Arn

        - Effect: Allow
          Action:
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            Fn::GetAtt:
              - UserCreatedQueue
              - Arn

        - Effect: Allow
          Action:
            - sns:Publish
          Resource:
            Ref: EmailNotificationTopic

package:
  individually: true

functions:
  createUserNode:
    runtime: nodejs20.x
    handler: src/handlers/createUser.createUser
    description: Create a new user (Node.js implementation)
    events:
      - httpApi:
          path: /api/serverless/users-node
          method: post
    timeout: 30
    memorySize: 256

  getUserNode:
    runtime: nodejs20.x
    handler: src/handlers/getUser.getUser
    description: Get user by ID (Node.js implementation)
    events:
      - httpApi:
          path: /api/serverless/users-node/{id}
          method: get
    timeout: 30
    memorySize: 256

  updateUserNode:
    runtime: nodejs20.x
    handler: src/handlers/updateUser.updateUser
    description: Update user by ID (Node.js implementation)
    events:
      - httpApi:
          path: /api/serverless/users-node/{id}
          method: put
    timeout: 30
    memorySize: 256

  deleteUserNode:
    runtime: nodejs20.x
    handler: src/handlers/deleteUser.deleteUser
    description: Delete user by ID (Node.js implementation)
    events:
      - httpApi:
          path: /api/serverless/users-node/{id}
          method: delete
    timeout: 30
    memorySize: 256

  enviarCorreosNode:
    runtime: nodejs20.x
    handler: src/handlers/enviarCorreos.enviarCorreos
    description: Send welcome email notifications via SNS (Node.js implementation)
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - UserCreatedQueue
              - Arn
          batchSize: 10
          functionResponseType: ReportBatchItemFailures
    timeout: 30
    memorySize: 256

resources:
  Resources:
    NodeUsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: node-${self:service}-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: email-index
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    UserCreatedQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: node-${self:service}-user-created-${self:provider.stage}
        VisibilityTimeout: 300
        MessageRetentionPeriod: 1209600
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - UserCreatedDLQ
              - Arn
          maxReceiveCount: 3
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    UserCreatedDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: node-${self:service}-user-created-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    EmailNotificationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: node-${self:service}-email-notifications-${self:provider.stage}
        DisplayName: User Email Notifications
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    UserCreatedQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - Ref: UserCreatedQueue
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                AWS:
                  Fn::GetAtt:
                    - IamRoleLambdaExecution
                    - Arn
              Action:
                - sqs:SendMessage
              Resource:
                Fn::GetAtt:
                  - UserCreatedQueue
                  - Arn

  Outputs:
    UserCreatedQueueUrl:
      Description: URL of the User Created SQS Queue
      Value:
        Ref: UserCreatedQueue
      Export:
        Name: ${self:service}-${self:provider.stage}-UserCreatedQueueUrl

    UserCreatedQueueArn:
      Description: ARN of the User Created SQS Queue
      Value:
        Fn::GetAtt:
          - UserCreatedQueue
          - Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-UserCreatedQueueArn

    EmailNotificationTopicArn:
      Description: ARN of the Email Notification SNS Topic
      Value:
        Ref: EmailNotificationTopic
      Export:
        Name: ${self:service}-${self:provider.stage}-EmailNotificationTopicArn

